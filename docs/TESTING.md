# ガンプラ見守りロボット - テストのやりかた

こんにちは！
この説明書は、「ガンプラ見守りロボット」がちゃんとお仕事をしてくれるか、チェックするためのやり方を書いています。
お父さんやお母さんと一緒に、または一人でチャレンジしてみよう！

## このロボットはなに？

みんなが欲しいガンプラ（ガンダムのプラモデル）が、お店（プレミアムバンダイ）で「売り切れ」から「在庫あり」に変わったとき、すぐにLINEでお知らせしてくれる、とっても便利なロボットだよ。

これがあれば、欲しかったガンプラを買いのがすことがなくなるかも！

## 「テスト」ってなに？

「テスト」っていうのは、このロボットがちゃんと約束通りに動いてくれるか、みんなで確認する作業のこと。

- ちゃんとお店を見張ってくれるかな？
- 「在庫あり」をちゃんと見つけられるかな？
- LINEでちゃんとお知らせしてくれるかな？

こういうことを一つずつチェックしていくよ。

## テストのじゅんび

ロボットを動かす前に、いくつか準備が必要だよ。

### 1. 環境変数（かんきょうへんすう）をせってい

ロボットがLINEでお知らせを送るために、「合言葉」が必要だよ。

- プロジェクトのフォルダに `.env` というファイルを作ろう（なければ新しく作る）
- 中身はこんな感じで書くよ：

```env
LINE_CHANNEL_ACCESS_TOKEN=ここにLINEのトークンを書く
```

> **トークンってなに？**: LINEの管理画面（LINE Developers）でもらえる長〜い文字列だよ。お父さんやお母さんに聞いてみてね。

### 2. 見張ってほしいガンプラのリストをつくる

どのガンプラを見張ってほしいか、ロボットに教えるためのリストだよ。

- `config` というフォルダの中にある `targets.csv` というファイルを開こう。
- CSVファイルは「カンマで区切った表」みたいなものだよ。Excelやメモ帳で編集できるよ。

**CSVファイルの書き方：**
```csv
id,name,url,lastStatus,enabled
item-1,すごいガンダム,https://p-bandai.jp/item/item-1000123456/,out_of_stock,true
```

**各項目の意味：**
| 項目 | 意味 |
|------|------|
| `id` | 商品を区別するためのID（好きな名前でOK） |
| `name` | ガンプラの名前（通知に表示される） |
| `url` | 見張ってほしいガンプラのページの住所（URL） |
| `lastStatus` | 最後にチェックしたときの状態（最初は `out_of_stock` でOK） |
| `enabled` | 見張りを有効にするか（`true` で有効） |

**複数の商品を見張る場合：**
```csv
id,name,url,lastStatus,enabled
item-1,すごいガンダム,https://p-bandai.jp/item/item-1000123456/,out_of_stock,true
item-2,かっこいいザク,https://p-bandai.jp/item/item-1000789012/,out_of_stock,true
```

### 3. お知らせする人をきめる（テスト用）

誰にLINEでお知らせするか、連絡先リストをつくるよ。

> **ポイント**: 在庫復活の本番通知は「友達全員」に届くよ。このファイルは「テスト通知」用だよ。

- `config` フォルダの中にある `users.csv` というファイルを開こう。

**CSVファイルの書き方：**
```csv
userId,displayName
U1234567890abcdef1234567890abcdef,自分のなまえ
```

**各項目の意味：**
| 項目 | 意味 |
|------|------|
| `userId` | LINEの自分のID（Uから始まる33文字） |
| `displayName` | 表示名（自分がわかりやすい名前でOK） |

- `userId`: LINEの自分のID（これはお父さんかお母さんに教えてもらおう）
- 取得方法は [ユーザーIDの取得方法](./GET_USER_ID.md) を見てね

---

## テストコマンド一覧

| コマンド | なにをする？ | 誰に届く？ |
|----------|-------------|-----------|
| `npm run start` | 在庫チェック | 在庫復活 → 友達全員 / テスト → users.csv |
| `npm run test:broadcast` | 一斉配信テスト | **友達全員** |
| `npm run test:push` | 指定ユーザーテスト | users.csvの人だけ |

---

## テストをやってみよう！

さあ、準備ができたら、いよいよロボットを動かしてみよう！
パソコンの黒い画面（ターミナル）で、下の「じゅもん」を打ち込んでね。

### テスト１：一斉配信テスト（友達全員に送信）

まず、LINEで友達全員にメッセージが届くかチェック！

**じゅもん**
```bash
npm run test:broadcast
```

成功するとこんな感じで表示されるよ：
```
🚀 ガンプラ在庫監視Bot 起動
⏰ 実行時刻: 2025/12/9 0:09:22

📢 一斉配信テストモード
⚠️  友達全員にテストメッセージを送信します！

✅ ブロードキャスト送信成功（友達全員に通知）
✅ 一斉配信テスト完了（友達全員に送信）
```

LINEを見て、テストメッセージが届いていたら成功！🎉

### テスト２：指定ユーザーテスト（users.csvの人だけ）

次に、`users.csv` に書いた人だけにメッセージが届くかチェック！

**じゅもん**
```bash
npm run test:push
```

成功するとこんな感じで表示されるよ：
```
🚀 ガンプラ在庫監視Bot 起動

📤 指定ユーザーテストモード
📋 users.csv に登録されたユーザーにのみ送信します

👥 送信先: 1人
   - 自分のなまえ
✅ メッセージ送信成功: 自分のなまえ
✅ 指定ユーザーテスト完了
```

### テスト３：在庫チェック（本番と同じ動き）

在庫チェックの本番と同じ動きをテストするよ。

**じゅもん**
```bash
npm run start
```

成功するとこんな感じで表示されるよ：
```
🚀 ガンプラ在庫監視Bot 起動
⏰ 実行時刻: 2025-12-09 00:10:00
📋 監視対象: 2件
👥 通知先（テスト用）: 1人
🌐 ブラウザを起動しました
📦 チェック開始: すごいガンダム
✅ チェック完了: すごいガンダム | out_of_stock → out_of_stock | 2500ms
...
📊 実行結果サマリー
  チェック済み: 2件
  変化あり: 0件
  在庫復活: 0件
✅ 処理完了
```

**在庫復活を検知したとき**:
- `🎉 在庫復活検知: すごいガンダム` と表示される
- **友達全員**にLINE通知が届く（Broadcast）

**在庫変化がないとき**:
- `users.csv` の人にだけテスト通知が届く（pushMessage）

---

## こまったときは

### `LINE_CHANNEL_ACCESS_TOKEN が設定されていません` と言われた

`.env` ファイルにトークンが書かれていないか、ファイルがないかも。

1. プロジェクトフォルダに `.env` ファイルがあるか確認
2. 中身が `LINE_CHANNEL_ACCESS_TOKEN=ここにトークン` の形式になっているか確認
3. トークンの前後に余分なスペースがないか確認

### `ファイルがないよ` って言われた

- `targets.csv` や `users.csv` の名前が間違っていないか、もう一度確認してみよう
- ファイルの1行目（ヘッダー）が正しいか確認しよう：
  - targets.csv: `id,name,url,lastStatus,enabled`
  - users.csv: `userId,displayName`

### うまく動かない…

- `targets.csv` の `url` が間違っているかも。ブラウザで開けるか確認してみよう
- CSVファイルの中にカンマ（,）が余分に入っていないか確認しよう
- それでもダメなら、お父さんやお母さんに聞いてみてね

---

## 通知の届き方まとめ

| シーン | 誰に届く？ | 使うAPI |
|--------|-----------|---------|
| 在庫復活を検知！ | 友達全員 | Broadcast |
| テスト通知（変化なし） | users.csvの人 | pushMessage |
| `npm run test:broadcast` | 友達全員 | Broadcast |
| `npm run test:push` | users.csvの人 | pushMessage |

これでテストは終わりだよ。おつかれさま！🎉
