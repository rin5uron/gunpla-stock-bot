# ガンプラ在庫監視Bot

プレミアムバンダイの商品在庫を自動で監視し、在庫が復活したらLINEで通知するシンプルなBotです。

### 主な機能

- **在庫の自動チェック**: 30分おきに在庫状況を自動で確認（ボタン・タグの多段階判定による高精度検出）。
- **LINEで通知**: 在庫復活を検知したら、**友達全員**に商品URLをLINE通知（Broadcast API）。
- **CSV管理**: 監視対象商品をCSVファイルで簡単に管理。
- **手動配信機能**: 現在の在庫状況を確認して手動で配信可能（`npm run test:status`）。

---

## 🚀 セットアップ

このBotは、GitHub Actionsの無料枠を使ってセットアップできます。

**詳細な手順はこちらのガイドをご覧ください:**

👉 **[セットアップガイド](./docs/SETUP.md)**

---

## 📚 ドキュメント

プロジェクトの詳細な情報は、以下のドキュメントをご覧ください：

- **[セットアップガイド](./docs/SETUP.md)** - 初期セットアップの手順
- **[仕様書](./docs/spec.md)** - プロジェクトの詳細な仕様とファイル構成
- **[テスト方法](./docs/TESTING.md)** - ローカルでのテスト方法と動作確認
- **[ユーザーIDの取得方法](./docs/GET_USER_ID.md)** - LINE通知先のユーザーIDを取得する手順

---

## 🧪 テストコマンド

| コマンド | 説明 | 送信先 |
|----------|------|--------|
| `npm run start` | 通常の在庫チェック | 在庫復活時のみ → 友達全員 |
| `npm run test:broadcast` | 一斉配信テスト | **友達全員** |
| `npm run test:push` | 指定ユーザーテスト | users.csvの人だけ |
| `npm run test:status` | 在庫状況配信（手動） | **友達全員** |

```bash
# 通常の在庫チェック（在庫復活時のみ通知）
npm run start

# 一斉配信テスト（友達全員に送信）
npm run test:broadcast

# 指定ユーザーテスト（users.csvの人だけに送信）
npm run test:push

# 在庫状況配信（現在の実際の在庫をチェックして友達全員に配信）
npm run test:status
```

---

## 🔧 高度な機能（オプション）

### ユーザーごとに通知を変えたい場合

現在の実装では、在庫復活時は友達全員に同じ通知を送信します（Broadcast）。

**特定のユーザーにだけ通知したい**場合は、`users.csv` にユーザーIDを登録して `npm run test:push` を使うか、以下のリソースを参照してください：

#### ブランチ: `feature/user-specific-notifications`

ユーザーID管理機能の実装が保存されています。

```bash
# ブランチを確認
git checkout feature/user-specific-notifications

# ブランチの差分を確認
git diff main...feature/user-specific-notifications
```

#### examplesディレクトリ

```
examples/user-id-management/
├── README.md                 # 使い方ガイド
├── getUserId.js              # Webhookサーバー（ユーザーIDを手動取得）
├── csvHelper.ts              # CSV読み書きヘルパー
└── docs/
    ├── GET_USER_ID.md        # ユーザーID取得の詳細手順書
    └── ERROR.md              # トラブルシューティングガイド
```

詳細は [examples/user-id-management/README.md](./examples/user-id-management/README.md) を参照してください。

**参考資料**:
- [GitHub Issue #11](https://github.com/rin5uron/gunpla-stock-bot/issues/11) - 実装過程とエラー対応の記録（2025/12/7）

---

## アーキテクチャ

- **設定ファイル (CSV)**:
  - `config/targets.csv`: 監視対象商品の管理（ID、商品名、URL、最終在庫状態）
  - `config/users.csv`: LINE通知先ユーザーの管理（LINE ユーザーID、表示名）※テスト用
- **在庫チェッカー (GitHub Actions)**:
  - 30分おきに起動し、Playwrightを使って商品ページのボタン判定により在庫を確認。
  - 在庫復活を検知したら、LINE Messaging APIで**友達全員**に商品URLを通知（Broadcast）。
  - スクレイピング対策のため、カート投入などの自動操作は一切行わない。

### 在庫判定ロジック（Phase 1 完了）

1. **ボタンのテキストで判定（最優先）**
   - 「カートに入れる」 → 在庫あり
   - 「予約する」 → 予約受付中
2. **タグで判定**
   - 「予約」タグ → 予約受付中
   - 「予約終了」タグ → 予約終了
3. **ページ全体のテキストで判定（フォールバック）**
   - ボタンやタグが見つからない場合、ページ全体から判定
4. **それ以外 → 売り切れとみなす**
5. **エラー時 → 不明（詳しくは商品ページをご覧ください）**

---

## 🛣️ 開発ロードマップ

### ✅ Phase 1: 在庫判定ロジックの改善（完了）

**実装内容**:
- ボタン要素を複数のセレクタで検索し、「カートに入れる」「予約する」を判定
- タグ要素を複数のセレクタで検索し、「予約」「予約終了」を判定
- ボタン → タグ → ページ全体の順で判定（フォールバック機能）
- エラー時は「詳しくは商品ページをご覧ください」のメッセージを表示
- 在庫変化なし時の自動通知を削除（在庫復活時のみ通知）
- 手動で在庫状況を配信する機能（`npm run test:status`）を追加

**効果**:
- より正確な在庫判定が可能に
- `unknown`（不明）状態が大幅に減少
- ユーザーにとって分かりやすいメッセージ表示

### 🔜 Phase 2: キーワード検索機能（計画中）

**実装予定**:
- 現在の監視中在庫をキーワードで確認する機能
- LINE経由でキーワード検索できる対話機能
- 商品の追加・削除をLINEから操作できる機能

**予定時期**: 未定（Phase 1の安定運用後に検討）

---

## ⚠️ 注意

- このBotは、プレミアムバンダイの利用規約を遵守する範囲で、個人の購入補助を目的としています。商業目的での利用や、他者への迷惑となるような過度な利用は固く禁じます。
- 本Botは在庫復活を通知するのみで、**自動購入・自動カート投入は一切行いません**。ボタンのテキスト判定のみで在庫状態を検出します。
- スクレイピング対策およびアカウントBAN防止のため、カート投入などの自動操作機能は実装していません。通知を受け取ったら、手動で購入手続きを行ってください。
- 本プログラムの利用によって生じたいかなる損害についても、開発者は責任を負いません。自己責任でご利用ください。

---

## 📖 その他のリソース

- **[学習記録](./docs/study.md)** - プロジェクト開発中の学習内容とメモ
